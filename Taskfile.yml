version: "3"
vars:
  KEY_NAME: "ec2-key-pair"
  SSH_ADDRESS:
    sh: cd ./infra && terraform output -raw ssh_address
  GOARCH: arm64
  GOOS: linux
tasks:
  dev:
    deps:
      - dev:server
      - dev:client # Run both servers in watch mode...
  dev:client:
    cmds:
      - cd client && pnpm install
      - cd client && pnpm run dev
  dev:server:
    cmds:
      - air serve --http=127.0.0.1:8080
  build:
    deps:
      - build:client
      - build:server
  build:client:
    cmds:
      - cd client && pnpm install
      - cd client && pnpm run build
  build:server:
    cmds:
      - GOOS={{ .GOOS }} GOARCH={{ .GOARCH }} CGO_ENABLED=0 go build -o pocketbase
  connect:
    cmds:
      - cd ./infra && exec $(terraform output -raw ssh)
  deploy:
    deps:
      - build
    cmds:
      - rsync -av -e "ssh -i ~/.ssh/{{ .KEY_NAME }}.pem" pb_public pocketbase pb_migrations "ec2-user@{{ .SSH_ADDRESS }}:/home/ec2-user/"
  infra:build:
    cmds:
      - cd infra && terraform init -var="key_name={{ .KEY_NAME }}"
      - cd infra && terraform apply -var="key_name={{ .KEY_NAME }}"
  infra:destroy:
    cmds:
      - cd infra && terraform destroy -var="key_name={{ .KEY_NAME }}"
  open:
    cmds:
      - cd ./infra && terraform output -raw instance_ip_addr
